<html>
<head>
	<title>OpenCities Map</title>
	<link rel="stylesheet" type="text/css" href="js/lib/leaflet-0.7/leaflet.css">
	<link rel="stylesheet" type="text/css" href="js/lib/leaflet.markercluster/leaflet.markercluster.css">
	<link rel="stylesheet" type="text/css" href="js/lib/leaflet.markercluster/MarkerCluster.Default.css">

	<script type="text/javascript" src="js/lib/jquery-1.7.2.min.js"></script>
	<script type="text/javascript" src="js/lib/leaflet-0.7/leaflet.js"></script>
	<script type="text/javascript" src="js/lib/spin.min.js"></script>
	<script type="text/javascript" src="js/lib/leaflet.spin.js"></script>
	<script type="text/javascript" src="js/lib/leaflet.ajax.js"></script>
	<script type="text/javascript" src="js/lib/leaflet.markercluster/leaflet.markercluster.js"></script>

	<style type="text/css">
		#map{
			width: 100%;
			height: 100%;
		}
	</style>
</head>
<body>
	<div id = "filterLayout"></div>
	<input type="button" id="hospitalFilter" value="hospital">
	<div id='map'>
    </div>
	<script type="text/javascript">
		function toTitleCase(str){
		    if(str){
		    	// debugger;
		    	string = str.replace(/_/," ");
		    	string = string.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
		    }
		    else{
		    	string = "";
		    }
		    return string;
		}
	</script>
	<script type="text/javascript">
		var testObject;
		var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
				maxZoom: 18,
				attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors, Points &copy 2012 LINZ'
			}),
			latlng = L.latLng(27.7, 85.3);

		var map = L.map('map', {center: latlng, zoom: 12, layers: [tiles]});

		var clusterMarkers = L.markerClusterGroup();
		var geojsonlayer = L.geoJson.ajax();
		// geojsonlayer.addTo(map);
		// geojsonlayer.addUrl("data/education_centroid.geojson");
		geojsonlayer.addUrl("data/health_centroid.geojson");
		// geojsonlayer.addUrl("data/health.geojson");
		// geojsonlayer.filter = function (feature){return feature.properties.amenity == "hospital"};
		clusterMarkers.addTo(map);
		
		geojsonlayer.on("data:loaded",function(){
			// console.log("(Object.keys(geojsonlayer._layers).length) = ",Object.keys(geojsonlayer._layers).length);
			geojsonlayer.eachLayer(function(c){
				// console.log("layer=",c);
				c.bindPopup(c.feature.properties.name);
				clusterMarkers.addLayer(L.marker([c.feature.geometry.coordinates[1],c.feature.geometry.coordinates[0]],{title:c.feature.properties.amenity}))
			});
			// console.log("inside first");			
		});
		// console.log("outside first");
		

		// Selecctor panel
		var filterLayout = {
			"amenity":{
				"hospital":null,
				"dentist":null,
				"clinic":null,
				"health_post":null
			},
			"operator_t":{
				"private":null,
				"government":null
			}
		}

		// generate filterLayout in HTML
		filterLayoutDiv = $("#filterLayout");
		for(key in filterLayout){
			keyClass = $("<div>",{
				text:key,
				class:"keyClass"
			}).appendTo(filterLayoutDiv);

			for(value in filterLayout[key]){
				console.log('value ' , value);
				valueClass = $("<label>",{
					text:value,
					name:key,
					value:value,
					class:"valueClass"
				}).appendTo(keyClass);
				valueClass.prepend("<input type='checkbox' name = '"+key+"' id='"+key+":"+value+"' checked></input>");
			}
		}
		
		// to be invoked on click
		$("#hospitalFilter").click(function(){
			clusterMarkers.clearLayers();
		geojsonlayer.eachLayer(function(c){
				// console.log("layer=",c);

				console.log("clearing hospitals")
				c.bindPopup(c.feature.properties.name);
				if(c.feature.properties.amenity == "hospital"){
				clusterMarkers.addLayer(L.marker([c.feature.geometry.coordinates[1],c.feature.geometry.coordinates[0]],{title:c.feature.properties.amenity}))}
			})})
	</script>
</body>
</html>