<html>
<head>
	<title>OpenCities Map</title>
	<link rel="stylesheet" type="text/css" href="js/lib/leaflet-0.7/leaflet.css">
	<link rel="stylesheet" type="text/css" href="js/lib/leaflet.markercluster/leaflet.markercluster.css">
	<link rel="stylesheet" type="text/css" href="js/lib/leaflet.markercluster/MarkerCluster.Default.css">
	<script type="text/javascript" src="js/lib/leaflet-0.7/leaflet.js"></script>
	<script type="text/javascript" src="js/lib/spin.min.js"></script>
	<script type="text/javascript" src="js/lib/leaflet.spin.js"></script>
	<script type="text/javascript" src="js/lib/leaflet.ajax.js"></script>
	<script type="text/javascript" src="js/lib/leaflet.markercluster/leaflet.markercluster.js"></script>

	<style type="text/css">
		#map{
			width: 100%;
			height: 100%;
		}
	</style>
</head>
<body>
	<div id='map'>
    </div>
	<script type="text/javascript">
		function toTitleCase(str){
		    if(str){
		    	// debugger;
		    	string = str.replace(/_/," ");
		    	string = string.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
		    }
		    else{
		    	string = "";
		    }
		    return string;
		}
	</script>
	<script type="text/javascript">
		var testObject;
		var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
				maxZoom: 18,
				attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors, Points &copy 2012 LINZ'
			}),
			latlng = L.latLng(27.7, 85.3);

		var map = L.map('map', {center: latlng, zoom: 12, layers: [tiles]});

		var clusterMarkers = L.markerClusterGroup();
		var geojsonlayer = L.geoJson.ajax();
		// geojsonlayer.addUrl("data/education_centroid.geojson");
		geojsonlayer.addUrl("data/health_centroid.geojson");
		// geojsonlayer.filter = function (feature){return feature.properties.amenity == "clinic"};
		clusterMarkers.addTo(map);
		
		geojsonlayer.on("data:loaded",function(){
			console.log("(Object.keys(geojsonlayer._layers).length) = ",Object.keys(geojsonlayer._layers).length);
			geojsonlayer.eachLayer(function(c){
			// console.log("layer=",c);
			c.bindPopup(c.feature.properties.amenity);
			clusterMarkers.addLayer(L.marker([c.feature.geometry.coordinates[1],c.feature.geometry.coordinates[0]],{title:c.feature.properties.name}))
			});
			console.log("inside first");
			
		});
		console.log("outside first");
		
	</script>
</body>
</html>